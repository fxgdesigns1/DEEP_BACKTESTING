<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Top-K Backtest Report</title>
  <style>
    body { font-family: -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    h1 { margin:0; font-size: 24px; }
    .meta { color:#555; font-size: 14px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap:16px; }
    .card { border:1px solid #e5e7eb; border-radius:12px; padding:16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .badge { display:inline-block; padding:2px 8px; border-radius: 999px; background:#eef2ff; color:#3730a3; font-size:12px; margin-right:6px; }
    .table { width:100%; border-collapse: collapse; margin-top: 8px; }
    .table th, .table td { text-align:left; border-bottom:1px solid #e5e7eb; padding:8px; font-size: 14px; }
    .section { margin-top: 24px; }
    .chart { width:100%; height:160px; background:#f9fafb; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#9ca3af; }
    .footer { color:#6b7280; font-size: 12px; margin-top: 24px; }
    code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <header>
    <h1>Top-K Backtest Report</h1>
    <div class="meta">
      Generated: <span id="generatedAt">{{generated_at}}</span> •
      Data checksum: <code>{{data_checksum}}</code>
    </div>
  </header>

  <section class="section">
    <h2>Summary</h2>
    <p>Universe: {{pairs}} @ {{timeframes}}. Strategies evaluated: {{strategies}}. 
    Total runs: {{total_runs}}. Kept (Top-K): {{top_k}}.</p>
  </section>

  <section class="section">
    <h2>Winners (Top-K)</h2>
    <div class="grid">
      {{#each top_configs}}
      <div class="card">
        <div>
          <span class="badge">{{strategy}}</span>
          <span class="badge">{{pair}}</span>
          <span class="badge">{{timeframe}}</span>
        </div>
        <h3 style="margin:8px 0 0 0;">{{title}}</h3>
        <table class="table">
          <tr><th>Sharpe (OOS, deflated)</th><td>{{sharpe_oos_deflated}}</td></tr>
          <tr><th>CAGR</th><td>{{cagr}}</td></tr>
          <tr><th>Max DD</th><td>{{max_dd}}</td></tr>
          <tr><th>Win rate</th><td>{{win_rate}}</td></tr>
          <tr><th>ESI</th><td>{{esi}}</td></tr>
          <tr><th>Trades</th><td>{{trades}}</td></tr>
        </table>
        <div class="chart">[Equity Curve Placeholder: {{equity_curve_img}}]</div>
        <div class="chart">[WFA Heatmap Placeholder: {{wfa_heatmap_img}}]</div>
        <div class="chart">[MC Fan Chart Placeholder: {{mc_fan_img}}]</div>
        <details style="margin-top:8px;">
          <summary>Parameters</summary>
          <pre>{{params_json}}</pre>
        </details>
      </div>
      {{/each}}
    </div>
  </section>

  <section class="section">
    <h2>Prop Firm Challenge Picks</h2>
    <p>Only configurations compliant with <code>config/prop_firm.yaml</code> are listed.</p>
    <div class="grid">
      {{#each prop_firm_picks}}
      <div class="card">
        <div>
          <span class="badge">PropFirm</span>
          <span class="badge">{{pair}}</span>
          <span class="badge">{{timeframe}}</span>
        </div>
        <h3 style="margin:8px 0 0 0;">{{title}}</h3>
        <table class="table">
          <tr><th>Sharpe (OOS, deflated)</th><td>{{sharpe_oos_deflated}}</td></tr>
          <tr><th>Max DD</th><td>{{max_dd}}</td></tr>
          <tr><th>ROR (target)</th><td>{{ror}}</td></tr>
          <tr><th>Daily risk</th><td>{{daily_risk}}</td></tr>
          <tr><th>Per-trade risk</th><td>{{per_trade_risk}}</td></tr>
        </table>
        <details style="margin-top:8px;">
          <summary>Deployment Bundle (frozen)</summary>
          <pre>{{deployment_bundle_json}}</pre>
        </details>
      </div>
      {{/each}}
    </div>
  </section>

  <section class="section">
    <h2>Notes & Filters</h2>
    <ul>
      <li>Fail-loud checks applied: dataset completeness, critical gaps, min points, synthetic data ban.</li>
      <li>Overfit guards: Deflated Sharpe, WFA monotonicity, regime robustness, cost sensitivity, capacity.</li>
      <li>Stress tests: Monte Carlo (trades shuffle, costs, latency, missing fills), +25% cost inflation.</li>
    </ul>
  </section>

  <div class="footer">
    Generated by Professional Algorithmic Trading Backtesting System • Template v1.0
  </div>
</body>
</html>
